name: Pipeline Securit√©

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  test-securite:
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3

      # -------------------------------------------------------------
      # Etape 1 : Scan des fichiers (Secrets + Config K8s)
      # -------------------------------------------------------------
      - name: Scan du repo (Secrets + Config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1' # Bloque le pipeline si secret ou grosse faille config
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------
      # Etape 2 : Scan des images Docker r√©f√©renc√©es
      # -------------------------------------------------------------
      
      # On installe Trivy manuellement (√ßa fait plus "authentique")
      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan des images Docker utilis√©es
        run: |
          echo "Recherche des images..."
          
          # La commande magique corrig√©e :
          # 1. On cherche "image:"
          # 2. --exclude-dir : On interdit d'aller fouiller dans .git et .cache (l√† o√π √ßa plantait)
          # 3. grep -v "#" : On ignore les lignes comment√©es
          # 4. awk/tr/sed : On nettoie pour garder juste le nom de l'image
          grep -r "image:" . --exclude-dir={.git,.github,.cache} | grep -v "#" | awk '{print $2}' | tr -d '"' | tr -d "'" | sort | uniq | sed '/^$/d' > liste_images.txt

          echo "--------------------------------"
          echo "Liste des images trouv√©es :"
          cat liste_images.txt
          echo "--------------------------------"

          # Petite s√©curit√© : si le fichier est vide, on quitte proprement
          if [ ! -s liste_images.txt ]; then
            echo "Aucune image trouv√©e, tout va bien."
            exit 0
          fi

          # On boucle sur chaque image
          while read image; do
              # S√©curit√© suppl√©mentaire pour √©viter de scanner des trucs bizarres
              if [[ "$image" != \#* ]]; then
                  echo "üõ°Ô∏è  Scan de l'image : $image ..."
                  # On lance le scan. Si c'est critique, √ßa exit 1 et le pipeline √©choue.
                  trivy image --scanners vuln --severity CRITICAL --exit-code 1 "$image"
              fi
          done < liste_images.txt
