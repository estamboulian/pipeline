name: Pipeline Securit√©

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  test-securite:
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3

      # -------------------------------------------------------------
      # Etape 1 : Scan des SECRETS
      # -------------------------------------------------------------
      - name: Recherche de Secrets (Mots de passe, Cl√©s API)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'secret'
          exit-code: '1' # Bloque le pipeline si un secret est d√©tect√©
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------
      # Etape 2 : Scan des Configs Kubernetes
      # -------------------------------------------------------------
      - name: Audit de la configuration Kubernetes
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'misconfig'
          exit-code: '0' # Informatif uniquement (ne bloque pas le pipeline)
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------
      # Etape 3 : Scan des images
      # -------------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan des images Docker utilis√©es
        run: |
          echo "Recherche des images..."
          
          # Extraction des images en ignorant les commentaires et dossiers techniques
          grep -rh "image:" . --exclude-dir={.git,.github,.cache} | sed 's/#.*//' | awk '{print $NF}' | tr -d '"' | tr -d "'" | sort | uniq | sed '/^$/d' > liste_images.txt

          echo "--------------------------------"
          echo "Liste des images √† scanner :"
          cat liste_images.txt
          echo "--------------------------------"

          if [ ! -s liste_images.txt ]; then
            echo "Aucune image trouv√©e."
            exit 0
          fi

          while read image; do
              if [[ -n "$image" ]]; then
                  echo "üõ°Ô∏è  Scan de l'image : $image ..."
                  # Scan des vuln√©rabilit√©s critiques
                  trivy image --scanners vuln --severity CRITICAL --exit-code 1 "$image"
              fi
          done < liste_images.txt
