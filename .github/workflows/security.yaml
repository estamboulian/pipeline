name: Pipeline Securit√©

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  test-securite:
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3

      # -------------------------------------------------------------
      # Etape 1 : Scan des fichiers (Secrets + Config K8s)
      # -------------------------------------------------------------
      - name: Scan du repo (Secrets + Config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------
      # Etape 2 : Scan des images Docker r√©f√©renc√©es
      # -------------------------------------------------------------
      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan des images Docker utilis√©es
        run: |
          echo "Recherche des images..."
          
          # CORRECTION MAJEURE ICI :
          # 1. grep -rh : le 'h' masque le nom du fichier pour ne pas d√©caler les colonnes
          # 2. awk '{print $NF}' : On prend le DERNIER mot de la ligne (l'image) plut√¥t que le 2√®me
          grep -rh "image:" . --exclude-dir={.git,.github,.cache} | grep -v "#" | awk '{print $NF}' | tr -d '"' | tr -d "'" | sort | uniq | sed '/^$/d' > liste_images.txt

          echo "--------------------------------"
          echo "Liste des images trouv√©es :"
          cat liste_images.txt
          echo "--------------------------------"

          if [ ! -s liste_images.txt ]; then
            echo "Aucune image trouv√©e, tout va bien."
            exit 0
          fi

          while read image; do
              # On ignore si la ligne trouv√©e est juste "image:" (cas d'une ligne vide ou mal form√©e)
              if [[ "$image" != "image:" ]] && [[ "$image" != \#* ]]; then
                  echo "üõ°Ô∏è  Scan de l'image : $image ..."
                  trivy image --scanners vuln --severity CRITICAL --exit-code 1 "$image"
              fi
          done < liste_images.txt
