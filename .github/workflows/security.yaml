name: Pipeline Securit√©

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  test-securite:
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3

      # -------------------------------------------------------------
      # Etape 1 : Scan des fichiers (Secrets + Config K8s)
      # -------------------------------------------------------------
      - name: Scan du repo (Secrets + Config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1' # Bloque le pipeline si secret ou grosse faille config
          severity: 'CRITICAL,HIGH'

      # -------------------------------------------------------------
      # Etape 2 : Scan des images Docker r√©f√©renc√©es
      # -------------------------------------------------------------
      
      # Installation manuelle de Trivy pour le script bash
      - name: Install Trivy
        run: |
          sudo apt-get install wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Scan des images Docker utilis√©es
        run: |
          echo "Recherche des images..."
          
          # 1. grep -rh : Recherche r√©cursive sans afficher le nom du fichier (-h)
          # 2. --exclude-dir : On ignore les dossiers caches et git
          # 3. sed 's/#.*//' : On enl√®ve les commentaires en fin de ligne (FIX du probl√®me nginx)
          # 4. awk '{print $NF}' : On prend le dernier mot de la ligne (le nom de l'image)
          grep -rh "image:" . --exclude-dir={.git,.github,.cache} | sed 's/#.*//' | awk '{print $NF}' | tr -d '"' | tr -d "'" | sort | uniq | sed '/^$/d' > liste_images.txt

          echo "--------------------------------"
          echo "Liste des images √† scanner :"
          cat liste_images.txt
          echo "--------------------------------"

          # Si aucune image n'est trouv√©e, on ne plante pas le script
          if [ ! -s liste_images.txt ]; then
            echo "Aucune image trouv√©e, tout va bien."
            exit 0
          fi

          # Boucle sur chaque image trouv√©e
          while read image; do
              # Petite s√©curit√© pour √™tre s√ªr que la chaine n'est pas vide
              if [[ -n "$image" ]]; then
                  echo "üõ°Ô∏è  Scan de l'image : $image ..."
                  # On scanne uniquement les vuln√©rabilit√©s (pas les secrets car d√©j√† fait en √©tape 1)
                  # exit-code 1 fait √©chouer le pipeline si critique
                  trivy image --scanners vuln --severity CRITICAL --exit-code 1 "$image"
              fi
          done < liste_images.txt
